name: Deploy Production to s3/Cloudfront

on:
    workflow_dispatch:
    release:
        types: [published]

env:
    AWS_REGION: ${{ vars.AWS_REGION }}
    AWS_S3_WEBSITE_BUCKET: ${{ vars.AWS_S3_WEBSITE_BUCKET }}

jobs:
    build_fe:
        name: Build and Test
        runs-on: ubuntu-latest
        environment: production

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Update submodules
              run: git submodule update --init --recursive

            - name: Install Node
              uses: actions/setup-node@v4
              with:
                  node-version: '22.17.0' # Latest LTS version

            - name: Cache node modules
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-build-
                      ${{ runner.os }}-

            - name: install dependencies and build
              run: |
                  cd pv-validation-hub-client
                  npm ci
                  npm run build

            - name: Move Build to tmp
              run: |
                  mkdir -p /tmp/workspace/build
                  mv -v pv-validation-hub-client/out/* /tmp/workspace/build

            - name: Temporarily save Build to artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-client
                  path: /tmp/workspace

    deploy_fe:
        needs: build_fe
        runs-on: ubuntu-latest
        environment: production
        steps:
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Retrieve saved Build
              uses: actions/download-artifact@v4
              with:
                  name: build-client
                  path: /tmp/workspace

            - name: Deploy to S3
              run: aws s3 sync /tmp/workspace/build/ s3://${{ env.AWS_S3_WEBSITE_BUCKET }} --acl public-read

            - name: Run CF invalidation
              run: aws cloudfront create-invalidation --distribution-id ${{ secrets.FE_CF_ID }} --paths '/*'
